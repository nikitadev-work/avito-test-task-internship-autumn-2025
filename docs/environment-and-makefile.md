# Окружение и команды Makefile

Этот документ описывает локальное окружение разработки и основные команды Makefile.

## Оглавление
- [Dev-окружение](#dev-окружение)
- [Контейнеры окружения](#состав-окружения)
- [Переменные окружения](#переменные-окружения)
- [Как всё работает вместе](#как-всё-работает-вместе)
- [Линтер](#линтер)


## Dev-окружение

В корне репозитория находится `Makefile`, который упрощает работу с окружением, тестами и нагрузкой.

```bash
# Запуск dev-окружения (сервис, Postgres, Prometheus, Grafana, Loki, Swagger и т.д.)
make dev-up

# Остановка окружения
make dev-down

# Перезапуск окружения
make dev-restart

# Полная очистка: остановка и удаление volumes
make clear-volumes

# Логи только сервиса
make dev-logs-pr-manager-service

# Логи всех контейнеров docker-compose
make dev-logs-all
```

## Состав окружения

| Компонент              | Назначение                                   | Порт          |
|------------------------|-----------------------------------------------|---------------|
| pr-manager-service     | Основной сервис                               | 8080          |
| PostgreSQL 16          | Хранилище данных                              | 5432          |
| Swagger UI             | Документация API (OpenAPI)                    | 8082          |
| Prometheus             | Метрики, сбор данных                          | 9090          |
| Grafana                | Дашборды метрик и логов                       | 3000          |
| Loki                   | Хранилище логов                               | 3100          |
| Promtail               | Агент, собирающий логи контейнеров            | (нет порта)   |
| Node Exporter          | Системные метрики хоста                       | 9100          |

## Переменные окружения

Сервис считывает конфигурацию из `.env` файла в каталоге `pr-manager-service`.  
Пример `.env.example` находится рядом и может использоваться как основа.

Основные параметры:

- `APP_NAME`, `APP_VERSION` — имя и версия сервиса.
- `HTTP_HOST`, `HTTP_PORT` — настройки HTTP-сервера.
- `PG_HOST`, `PG_PORT`, `PG_USER`, `PG_PASSWORD`, `PG_DATABASE` — доступ к PostgreSQL.

## Как всё работает вместе

- PostgreSQL поднимается первым.
- Контейнер `migrate` применяет SQL-миграции из `pr-manager-service/migrations`.
- После успешных миграций запускается `pr-manager-service`.
- Мониторинг (Prometheus + Grafana) и логирование (Loki + Promtail) поднимаются параллельно.
- Swagger UI монтирует OpenAPI-файл из `docs/contracts/` и доступен по `http://localhost:8082`.

Данное окружение необходимо для комфортной локальной разработки — достаточно запустить `make dev-up`.

## Линтер

```bash
# Линтинг сервиса
make lint-pr-manager-service

# Линтинг общего модуля common/kit
make lint-common

# Линтинг всего проекта
make lint
```

`.golangci.yml` лежит в репозитории сервиса, в конфигурации включены проверки:

- форматирование (gofumpt),
- базовые ошибки (errcheck, unused),
- стиль (revive и др.).

## Интеграционные тесты через Makefile

```bash
# Интеграционные тесты (требуется запущенный сервис: make dev-up)
make test-integration
```
